<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .app {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      height: 700px;
    }
    header {
      background: #0072ff;
      color: #ffffff;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    header h1 {
      font-size: 16px;
      font-weight: 700;
    }
    header span {
      font-size: 12px;
      opacity: 0.9;
    }
    .chat-area {
      flex: 1;
      padding: 12px 14px;
      overflow-y: auto;
      background: #f9fafb;
    }
    .msg {
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    .msg-bot .bubble {
      background: #e5e7eb;
      color: #111827;
      border-radius: 14px;
      border-bottom-left-radius: 4px;
    }
    .bubble {
      font-size: 13px;
      padding: 9px 11px;
      line-height: 1.4;
      max-width: 85%;
      white-space: pre-line;
    }
    .link-list {
      margin-top: 6px;
      font-size: 12px;
    }
    .link-list a {
      color: #2563eb;
      text-decoration: none;
    }
    .link-list a:hover {
      text-decoration: underline;
    }
    .btn-area {
      border-top: 1px solid #e5e7eb;
      padding: 10px 10px 14px;
      background: #ffffff;
    }
    .btn-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .btn-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: #ffffff;
      cursor: pointer;
    }
    .chip-btn.main {
      font-weight: 600;
    }
    .chip-btn:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ì±—ë´‡</h1>
    <span>ëŒ€ì¹˜í•™ì› ì•ˆë‚´</span>
  </header>

  <div class="chat-area" id="chat"></div>

  <div class="btn-area">
    <div class="btn-title" id="btn-title">ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
    <div class="btn-list" id="btn-list"></div>
  </div>
</div>

<script>
  /* ===============================
     0) russel.json ë¡œë”© (ì„±ì ë³„ ì¶”ì²œìš©)
     =============================== */
  let COURSE_DATA = [];
  let COURSE_LOADED = false;
  let COURSE_LOAD_FAILED = false;

  fetch("russel.json")
    .then(res => res.json())
    .then(data => {
      if (Array.isArray(data)) {
        COURSE_DATA = data;
      } else if (Array.isArray(data.courses)) {
        COURSE_DATA = data.courses;
      } else if (Array.isArray(data.data)) {
        COURSE_DATA = data.data;
      } else {
        COURSE_DATA = [];
        console.error("ì§€ì›í•˜ì§€ ì•ŠëŠ” russel.json í˜•ì‹:", data);
      }
      COURSE_LOADED = true;
      console.log("ì‹œê°„í‘œ JSON ë¡œë”© ì™„ë£Œ, ê¸¸ì´:", COURSE_DATA.length);
    })
    .catch(err => {
      COURSE_LOAD_FAILED = true;
      console.error("russel.json ë¡œë”© ì˜¤ë¥˜:", err);
    });

  const RECOMMEND_MENU_KEY = "ì„±ì ë³„ ìˆ˜ì—… ì¶”ì²œ";
  const SUBJECT_LIST = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™", "ë…¼ìˆ "];
  const LEVEL_LIST = ["1~2ë“±ê¸‰", "2~3ë“±ê¸‰", "3~4ë“±ê¸‰"];

  /* ===============================
     1) ìƒë‹¨ ë©”ë‰´ & URL ì„¤ì •
     =============================== */
  const MENU_DATA = {
 "í•™ì› ì´ìš© ê°€ì´ë“œ": [
    {
      "label": "í•™ì› ê³µì§€ì‚¬í•­",
      "desc": "ìµœê·¼ í•™ì› ê³µì§€ ë° ì•ˆë‚´ì‚¬í•­",
      "url": "https://russeldc.megastudy.net/russel/info/notice/notice.asp"
    },
    {
      "label": "ìì£¼í•˜ëŠ” ì§ˆë¬¸",
      "desc": "ë“±ë¡, ìˆ˜ê°•, í™˜ë¶ˆ ë“± FAQ",
      "url": "https://russeldc.megastudy.net/russel/info/qna/faq.asp"
    },
    {
      "label": "1:1 ì˜¨ë¼ì¸ ìƒë‹´",
      "desc": "ì˜¨ë¼ì¸ í•™ìŠµÂ·ì§„í•™ ìƒë‹´ ì‹ ì²­",
      "url": "https://russeldc.megastudy.net/russel/info/qna/qna.asp"
    },
    {
      "label": "ì„¤ëª…íšŒ ì˜ˆì•½/ì•Œë¦¼",
      "desc": "ì„¤ëª…íšŒ ì¼ì • í™•ì¸ ë° ì•Œë¦¼ ì‹ ì²­",
      "url": "https://russeldc.megastudy.net/russel/entinfo/entry_pt/enter_pt_list.asp"
    },
    {
      "label": "í•™ì› ì‹œì„¤",
      "desc": "ê°•ì˜ì‹¤, ììŠµì‹¤ ë“± ì‹œì„¤ ì•ˆë‚´",
      "url": "https://russeldc.megastudy.net/russel/info/campus_facility.asp"
    },
    {
      "label": "ì˜¤ì‹œëŠ” ê¸¸",
      "desc": "ëŸ¬ì…€ ëŒ€ì¹˜í•™ì› ìœ„ì¹˜ ì•ˆë‚´",
      "url": "https://russeldc.megastudy.net/russel/info/location.asp"
    },
    {
      "label": "ë¬¸ì ì•Œë¦¼ ì‹ ì²­",
      "desc": "í•™ì› ë¬¸ì ì•Œë¦¼ ì‹ ì²­/ê´€ë¦¬",
      "url": "https://russeldc.megastudy.net/russel/entinfo/entry_pt/enter_pt_list.asp"
    }
  ],
    "ë°”ë¥¸ê³µë¶€ ììŠµì „ìš©ê´€": [
      {
        "label": "ììŠµì „ìš©ê´€ ì•ˆë‚´",
        "desc": "ë°”ë¥¸ê³µë¶€ ììŠµì „ìš©ê´€ ìš´ì˜Â·ì´ìš© ì•ˆë‚´",
        "url": "https://russeldc.megastudy.net/russel/info/study_hall/study_hall.asp"
      },
      {
        "label": "ì¬í•™ìƒ íŠ¹ë³„ í˜œíƒ",
        "desc": "ì¬í•™ìƒ ëŒ€ìƒ íŠ¹ë³„ í˜œíƒ ì•ˆë‚´",
        "url": "https://russeldc.megastudy.net/russel/event/2020/megapass/megapass.asp"
      },
      {
        "label": "ì£¼ê°„ ì‹ë‹¨í‘œ",
        "desc": "ì´ë²ˆ ì£¼ í•™ì› ì‹ë‹¨í‘œ í™•ì¸",
        "url": "https://russeldc.megastudy.net/russel/campus_common/campus/weekly_food.asp"
      }
    ],
    "ëª¨ì˜ê³ ì‚¬ ì¼ì •/ì½˜í…ì¸ ": [
      {
        "label": "2026ë…„ ëª¨ì˜ê³ ì‚¬ ì¼ì •",
        "desc": "2026ë…„ ëŸ¬ì…€ ëª¨ì˜ê³ ì‚¬ ì¼ì • ì•ˆë‚´",
        "url": "https://russeldc.megastudy.net/russel/entinfo/test_schedule.asp?year=2026"
      },
      {
        "label": "OMEGA ëª¨ì˜ê³ ì‚¬",
        "desc": "OMEGA ëª¨ì˜ê³ ì‚¬ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/event/omega_intro/index.asp"
      },
      {
        "label": "ì „êµ­ ëŒ€ë‹¨ìœ„ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬",
        "desc": "ì „êµ­ ëŒ€ë‹¨ìœ„ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ ì•ˆë‚´",
        "url": "https://russeldc.megastudy.net/event/2025/jdsm/index.asp"
      },
      {
        "label": "ë©”ëŒ€í”„ ëª¨ì˜ê³ ì‚¬",
        "desc": "ë©”ëŒ€í”„ ëª¨ì˜ê³ ì‚¬ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/intro/2022/premium/index.asp"
      },
      {
        "label": "ALPHA ëª¨ì˜ê³ ì‚¬",
        "desc": "ALPHA ëª¨ì˜ê³ ì‚¬ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/event/2025/alpha/index.asp"
      }
    ],
    "ì¶œê°• ì„ ìƒë‹˜ ì•ˆë‚´": [
      {
        "label": "êµ­ì–´",
        "desc": "êµ­ì–´ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0023"
      },
      {
        "label": "ìˆ˜í•™",
        "desc": "ìˆ˜í•™ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0024"
      },
      {
        "label": "ì˜ì–´",
        "desc": "ì˜ì–´ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0025"
      },
      {
        "label": "í•œêµ­ì‚¬",
        "desc": "í•œêµ­ì‚¬ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0049"
      },
      {
        "label": "ì‚¬íšŒ",
        "desc": "ì‚¬íšŒ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0026"
      },
      {
        "label": "ê³¼í•™",
        "desc": "ê³¼í•™ ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0027"
      },
      {
        "label": "ë…¼ìˆ ",
        "desc": "ë…¼ìˆ  ì¶œê°• ì„ ìƒë‹˜ ì†Œê°œ",
        "url": "https://russeldc.megastudy.net/russel/teacher/teacher.asp?te_les=CD0028"
      }
    ],
    "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´": [
      {
        "label": "ìˆ˜ê°•ì •ë³´",
        "desc": "í˜„ì¬ ìˆ˜ê°•ì¤‘/ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­ ì¡°íšŒ",
        "url": "https://russeldc.megastudy.net/russel/mypage/lecture_course.asp"
      },
      {
        "label": "ëŒ€ê¸°ì •ë³´",
        "desc": "ëŒ€ê¸° ê°•ì¢Œ ë° ëŒ€ê¸°ë²ˆí˜¸ ì¡°íšŒ",
        "url": "https://russeldc.megastudy.net/russel/mypage/waiting.asp"
      },
      {
        "label": "ê²°ì œë‚´ì—­",
        "desc": "ê²°ì œë‚´ì—­ ë° ì˜ìˆ˜ì¦ ì¡°íšŒ",
        "url": "https://russeldc.megastudy.net/russel/mypage/student/account_list.asp"
      },
      {
        "label": "í™˜ë¶ˆì‹ ì²­",
        "desc": "ë‹¨ê³¼/êµì¬/ë°”ìê´€ í™˜ë¶ˆì‹ ì²­ ë©”ë‰´",
        "url": ""
      }
    ],
    "ë‹¨ê³¼/ëª¨ì˜ê³ ì‚¬ ì•ˆë‚´": [
    {
      label: "ëª¨ì˜ê³ ì‚¬ êµ¬ë§¤",
      desc: "ëŸ¬ì…€ ëª¨ì˜ê³ ì‚¬ êµ¬ë§¤",
      url: "https://russeldc.megastudy.net/russel/online_mock/index.asp"
    }
  ]
  };

  /* ===============================
     2) ê³µí†µ UI / ì „ì—­
     =============================== */

  const chat = document.getElementById("chat");
  const btnList = document.getElementById("btn-list");
  const btnTitle = document.getElementById("btn-title");

  const MAIN_MENUS = [...Object.keys(MENU_DATA), RECOMMEND_MENU_KEY];

  const SHEET_WEBHOOK_URL =
    "https://script.google.com/macros/s/AKfycbyyz-H4DhCk3fRDOJIo55ReRVabSCccHLAmfNbsgBvu8z3IiyUJH10mWDR9Ca371tMM/exec";

  const currentCoursesData = []; // ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ìš© (í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì±„ìš°ê¸°)

  function addBotMessage(text, linksHtml = "") {
    const wrap = document.createElement("div");
    wrap.className = "msg msg-bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    wrap.appendChild(bubble);

    if (linksHtml) {
      const box = document.createElement("div");
      box.className = "link-list";
      box.innerHTML = linksHtml;
      bubble.appendChild(document.createElement("br"));
      bubble.appendChild(box);
    }

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function renderMainButtons() {
    btnTitle.textContent = "ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    btnList.innerHTML = "";
    MAIN_MENUS.forEach(menu => {
      const btn = document.createElement("button");
      btn.className = "chip-btn main";
      btn.textContent = menu;
      btn.onclick = () => {
        if (menu === RECOMMEND_MENU_KEY) {
          openRecommendFlow();
        } else {
          openMenu(menu);
        }
      };
      btnList.appendChild(btn);
    });
  }

  function openMenu(menuName) {
    const items = MENU_DATA[menuName];
    if (!items) return;

    addBotMessage(`ã€${menuName}ã€ ê´€ë ¨ ì£¼ìš” ë©”ë‰´ì…ë‹ˆë‹¤.\nì›í•˜ì‹œëŠ” í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.`);

    btnTitle.textContent = `${menuName} ì„¸ë¶€ ë©”ë‰´`;
    btnList.innerHTML = "";

    items.forEach(item => {
      const btn = document.createElement("button");
      btn.className = "chip-btn";
      btn.textContent = item.label;
      btn.title = item.desc;

      if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ìˆ˜ê°•ì •ë³´") {
        btn.onclick = () => handleCourseInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ëŒ€ê¸°ì •ë³´") {
        btn.onclick = () => handleWaitingInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ê²°ì œë‚´ì—­") {
        btn.onclick = () => handlePaymentInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "í™˜ë¶ˆì‹ ì²­") {
        btn.onclick = () => renderRefundSubMenu();
      } else {
        btn.onclick = () => {
          const html = `<a href="${item.url}" target="_blank">${item.label} ë°”ë¡œê°€ê¸°</a>`;
          addBotMessage(`${item.label} í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n(${item.desc})`, html);
          window.open(item.url, "_blank");
        };
      }

      btnList.appendChild(btn);
    });

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ì²˜ìŒìœ¼ë¡œ";
    homeBtn.onclick = () => {
      addBotMessage("ì²˜ìŒ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
      renderMainButtons();
    };
    btnList.appendChild(homeBtn);
  }

  /* ===============================
     3) ì„±ì ë³„ ìˆ˜ì—… ì¶”ì²œ ë¡œì§
     =============================== */

  // ê³¼ëª© ì´ë¦„ í†µì¼ (ìˆ˜1/ìˆ˜2/ë¯¸ì /í™•í†µ/ê³µí†µ ë“± â†’ ìˆ˜í•™)
  function normalizeSubject(rawSubject) {
    const s = String(rawSubject || "").replace(/\s/g, ""); // ê³µë°± ì œê±°

    const mathSet = ["ìˆ˜1", "ìˆ˜2", "ë¯¸ì ", "í™•í†µ", "ê³µí†µ", "ê³µí†µ,ë¯¸ì ", "ë¯¸ì ,ê³µí†µ"];
    if (mathSet.includes(s)) return "ìˆ˜í•™";

    if (s === "êµ­ì–´") return "êµ­ì–´";

    if (["ì‚¬íšŒ", "ìƒí™œê³¼ìœ¤ë¦¬", "í•œêµ­ì‚¬"].includes(s)) return "ì‚¬íšŒ";

    if (["ë¬¼ë¦¬í•™1", "ìƒëª…ê³¼í•™1"].includes(s)) return "ê³¼í•™";

    return s; // ì˜ì–´, ë…¼ìˆ  ë“±ì€ ê·¸ëŒ€ë¡œ
  }

  function recommendCourses(subject, levelText) {
    const targetSubject = String(subject || "").replace(/\s/g, "");

    return COURSE_DATA.filter(item => {
      const subj = normalizeSubject(item.subject);
      const lvl  = String(item.level_text || "").trim();
      return subj === targetSubject && lvl === levelText;
    });
  }

  function showRecommendResult(subject, levelText) {
    // ì•„ì§ JSONì´ ì•ˆ ì½íŒ ìƒíƒœ
    if (!COURSE_LOADED && !COURSE_LOAD_FAILED && COURSE_DATA.length === 0) {
      addBotMessage("ì‹œê°„í‘œ ë°ì´í„°ê°€ ì•„ì§ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì„±ì ë³„ ìˆ˜ì—… ì¶”ì²œì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
      return;
    }

    // ë¡œë”© ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš° (ë¡œì»¬ file://ì—ì„œ ë§ì´ ë‚¨)
    if (COURSE_LOAD_FAILED) {
      addBotMessage(
        "ì‹œê°„í‘œ ë°ì´í„°(russel.json)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" +
        "index.htmlê³¼ russel.jsonì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€, ê·¸ë¦¬ê³  http ì„œë²„(ì˜ˆ: GitHub Pages, Live Server)ì—ì„œ ì—´ì—ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
      );
      return;
    }

    const list = recommendCourses(subject, levelText);

    let text = `ã€${subject} / ${levelText}ã€ ìˆ˜ì—… ì¶”ì²œì…ë‹ˆë‹¤.\n\n`;

    if (list.length === 0) {
      text += "í•´ë‹¹ ì¡°ê±´ì˜ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.";
    } else {
      list.forEach((c, idx) => {
        text += `${idx + 1}. ${c.title} - ${c.teacher}\n`;
        text += `   ìš”ì¼: ${c.day}, ì‹œê°„: ${c.time_raw}\n\n`;
      });
    }

    addBotMessage(text.trim());
    renderRecommendResultButtons(subject, levelText);
  }

  function renderRecommendResultButtons(subject, levelText) {
    btnTitle.textContent = `${subject} / ${levelText} ì¶”ì²œ ê²°ê³¼`;
    btnList.innerHTML = "";

    const againBtn = document.createElement("button");
    againBtn.className = "chip-btn";
    againBtn.textContent = "ë‹¤ë¥¸ ë“±ê¸‰ ë³´ê¸°";
    againBtn.onclick = () => renderRecommendLevelButtons(subject);
    btnList.appendChild(againBtn);

    const subjBtn = document.createElement("button");
    subjBtn.className = "chip-btn";
    subjBtn.textContent = "ê³¼ëª© ë‹¤ì‹œ ì„ íƒ";
    subjBtn.onclick = () => renderRecommendSubjectButtons();
    btnList.appendChild(subjBtn);

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ì²˜ìŒìœ¼ë¡œ";
    homeBtn.onclick = () => renderMainButtons();
    btnList.appendChild(homeBtn);
  }

  function openRecommendFlow() {
    addBotMessage(
      "ì„±ì ë³„ ìˆ˜ì—… ì¶”ì²œì…ë‹ˆë‹¤.\n" +
      "ì›í•˜ì‹œëŠ” ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”."
    );
    renderRecommendSubjectButtons();
  }

  function renderRecommendSubjectButtons() {
    btnTitle.textContent = "ê³¼ëª© ì„ íƒ";
    btnList.innerHTML = "";

    SUBJECT_LIST.forEach(sub => {
      const btn = document.createElement("button");
      btn.className = "chip-btn";
      btn.textContent = sub;
      btn.onclick = () => renderRecommendLevelButtons(sub);
      btnList.appendChild(btn);
    });

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ì²˜ìŒìœ¼ë¡œ";
    homeBtn.onclick = () => renderMainButtons();
    btnList.appendChild(homeBtn);
  }

  function renderRecommendLevelButtons(subject) {
    btnTitle.textContent = subject + " / ë“±ê¸‰ ì„ íƒ";
    btnList.innerHTML = "";

    LEVEL_LIST.forEach(lv => {
      const btn = document.createElement("button");
      btn.className = "chip-btn";
      btn.textContent = lv;
      btn.onclick = () => showRecommendResult(subject, lv);
      btnList.appendChild(btn);
    });

    const backBtn = document.createElement("button");
    backBtn.className = "chip-btn";
    backBtn.textContent = "â—€ ê³¼ëª© ë‹¤ì‹œ ì„ íƒ";
    backBtn.onclick = () => renderRecommendSubjectButtons();
    btnList.appendChild(backBtn);
  }

  /* ===============================
     4) ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ / í™˜ë¶ˆ ë¡œì§
     =============================== */

  function handleCourseInfo() {
    const currentCourses = [];
    const pastCourses = [];

    if (currentCourses.length === 0) {
      addBotMessage("ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    } else {
      let msg = "ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œ ëª©ë¡:\n\n";
      currentCourses.forEach((c, i) => {
        msg += `${i + 1}. ${c}\n`;
      });
      addBotMessage(msg);
    }

    if (pastCourses.length === 0) {
      addBotMessage("ğŸ“š ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    } else {
      let msg = "ğŸ“š ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­:\n\n";
      pastCourses.forEach((c, i) => {
        msg += `${i + 1}. ${c}\n`;
      });
      addBotMessage(msg);
    }
  }

  function handleWaitingInfo() {
    const waitingList = [];

    if (waitingList.length === 0) {
      addBotMessage("í˜„ì¬ ëŒ€ê¸°ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    let msg = "ğŸ“‹ ëŒ€ê¸°ì •ë³´ ëª©ë¡\n\n";
    waitingList.forEach((item, i) => {
      msg += `${i + 1}) í•™ë°˜/ê°•ì¢Œ: ${item.lecture}\n`;
      msg += `   ë‹´ì„/ê°•ì‚¬: ${item.teacher}\n`;
      msg += `   ëŒ€ê¸°ë²ˆí˜¸: ${item.waitNo}ë²ˆ\n\n`;
    });
    addBotMessage(msg);
  }

  function handlePaymentInfo() {
    const paymentList = [];

    if (paymentList.length === 0) {
      addBotMessage("ğŸ’³ ê²°ì œë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    let msg = "ğŸ’³ ê²°ì œë‚´ì—­\n\n";
    paymentList.forEach((p, i) => {
      msg += `${i + 1}) í•™ì›: ${p.campus}\n`;
      msg += `   ê²°ì œì¼ì: ${p.date}\n`;
      msg += `   êµ¬ë§¤ë‚´ì—­: ${p.item}\n`;
      msg += `   ê²°ì œê¸ˆì•¡: ${p.amount}\n`;
      msg += `   ê²°ì œìˆ˜ë‹¨: ${p.method}\n`;
      msg += `   ìƒíƒœ: ${p.status}\n\n`;
    });
    addBotMessage(msg);
  }

  function renderRefundSubMenu() {
    addBotMessage("ì›í•˜ì‹œëŠ” í™˜ë¶ˆ ìœ í˜•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");

    btnTitle.textContent = "í™˜ë¶ˆì‹ ì²­ ì„¸ë¶€ ë©”ë‰´";
    btnList.innerHTML = "";

    const subMenus = [
      { label: "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­" },
      { label: "êµì¬í™˜ë¶ˆ ì‹ ì²­" },
      { label: "ë°”ìê´€í™˜ë¶ˆ ì‹ ì²­" }
    ];

    subMenus.forEach(sub => {
      const b = document.createElement("button");
      b.className = "chip-btn";
      b.textContent = sub.label;

      if (sub.label === "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­") {
        b.onclick = () => handleRefundSingle();
      } else {
        b.onclick = () => addBotMessage(`${sub.label} ê¸°ëŠ¥ì€ ì¶”í›„ ì˜¤í”ˆ ì˜ˆì •ì…ë‹ˆë‹¤.`);
      }

      btnList.appendChild(b);
    });

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ë¡œ";
    homeBtn.onclick = () => openMenu("ë‚˜ì˜ ìˆ˜ê°•ì •ë³´");
    btnList.appendChild(homeBtn);
  }

  function getStudentInfo() {
    let name = localStorage.getItem("studentName");
    let studentId = localStorage.getItem("studentId");

    if (!name || !studentId) {
      name = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:");
      studentId = prompt("ì¬ì›ìƒ í•™ë²ˆ(6~7ìë¦¬)ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:");

      if (!name || !studentId) {
        alert("ì´ë¦„ê³¼ í•™ë²ˆ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return null;
      }

      localStorage.setItem("studentName", name);
      localStorage.setItem("studentId", studentId);
    }
    return { name, studentId };
  }

  function sendRefundToSheet(type, name, studentId, courses) {
    fetch(SHEET_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type, name, studentId, courses })
    })
      .then(res => res.text())
      .then(text => console.log("Google Sheet Response:", text))
      .catch(err => console.error("Error:", err));
  }

  function handleRefundSingle() {
    const student = getStudentInfo();
    if (!student) return;

    const courseList = currentCoursesData || [];

    if (courseList.length === 0) {
      addBotMessage("ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    addBotMessage("í™˜ë¶ˆ ì‹ ì²­í•  ê°•ì¢Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.\n(ì—¬ëŸ¬ ê³¼ëª© ì„ íƒ ê°€ëŠ¥)");

    btnTitle.textContent = "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­ - ê°•ì¢Œ ì„ íƒ";
    btnList.innerHTML = "";

    courseList.forEach(course => {
      const label = document.createElement("label");
      label.style.display = "flex";
      label.style.alignItems = "center";
      label.style.gap = "6px";
      label.style.fontSize = "12px";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = course;

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(course));
      btnList.appendChild(label);
    });

    const okBtn = document.createElement("button");
    okBtn.className = "chip-btn";
    okBtn.textContent = "ì„ íƒ ì™„ë£Œ";
    okBtn.style.marginTop = "10px";

    okBtn.onclick = () => {
      const selected = [...btnList.querySelectorAll("input[type=checkbox]:checked")].map(x => x.value);

      if (selected.length === 0) {
        addBotMessage("ì„ íƒëœ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      addBotMessage(`ì´ ${selected.length}ê°œ ê°•ì¢Œ í™˜ë¶ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      sendRefundToSheet("single", student.name, student.studentId, selected);
    };

    btnList.appendChild(okBtn);
  }

  /* ===============================
     5) ì´ˆê¸° ì‹¤í–‰
     =============================== */

  function init() {
    const firstMsg =
      "ì•ˆë…•í•˜ì„¸ìš”. ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ëŒ€ì¹˜í•™ì› ì±—ë´‡ì…ë‹ˆë‹¤.\n\n" +
      "í•™ì› ì´ìš©, ëª¨ì§‘ìš”ê°•, ë‹¨ê³¼ ì‹œê°„í‘œ, ììŠµì „ìš©ê´€, ëª¨ì˜ê³ ì‚¬, ì¶œê°• ì„ ìƒë‹˜ ì•ˆë‚´ì™€\n" +
      "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´, ì„±ì ë³„ ìˆ˜ì—… ì¶”ì²œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.\n" +
      "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    addBotMessage(firstMsg);
    renderMainButtons();
  }

  init();
</script>
</body>
</html>
